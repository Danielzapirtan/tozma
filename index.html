<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depozite Materiale CizmƒÉrie</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
        .header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:30px;text-align:center}
        .header h1{font-size:2em;margin-bottom:10px}.header p{opacity:.9;font-size:1.1em}
        .controls{padding:30px;background:#f8f9fa;border-bottom:1px solid #e0e0e0}
        .input-group,.radius-group{margin-bottom:20px}
        .input-group label,.radius-group label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50}
        .input-group input{width:100%;padding:12px 15px;border:2px solid #ddd;border-radius:10px;font-size:1em;transition:border-color .3s}
        .input-group input:focus{border-color:#667eea;outline:0}
        .radius-slider{width:100%;margin:10px 0}.radius-value{text-align:center;font-weight:600;color:#667eea;margin-top:5px}
        .btn-group{display:flex;gap:15px;flex-wrap:wrap}
        .btn{flex:1;min-width:150px;padding:15px 30px;border:none;border-radius:10px;font-size:1em;font-weight:600;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:.5px}
        .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.4)}
        .btn-secondary{background:#95a5a6;color:#fff}
        .btn-secondary:hover{background:#7f8c8d}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        #map{height:500px;width:100%}
        .results{padding:30px}.results h2{color:#2c3e50;margin-bottom:20px;font-size:1.5em}
        .store-card{background:#fff;border:2px solid #e0e0e0;border-radius:15px;padding:20px;margin-bottom:20px;transition:.3s}
        .store-card:hover{border-color:#667eea;box-shadow:0 5px 15px rgba(102,126,234,.2);transform:translateY(-2px)}
        .store-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:15px}
        .store-name{font-size:1.3em;font-weight:700;color:#2c3e50}.distance{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:5px 15px;border-radius:20px;font-weight:600;font-size:.9em}
        .store-info{color:#555;line-height:1.8}.store-info strong{color:#2c3e50}
        .coordinates{font-family:monospace;color:#666;font-size:0.9em;margin-top:8px;padding:6px 10px;background:#f8f9fa;border-radius:6px;display:inline-block}
        .navigation-links{margin-top:15px;padding-top:15px;border-top:1px dashed #ddd}
        .nav-instructions{color:#666;font-size:0.9em;margin-bottom:10px}
        .nav-buttons{display:flex;gap:10px;flex-wrap:wrap}
        .nav-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;color:white;text-decoration:none;border-radius:8px;font-weight:600;transition:all 0.3s;border:none;cursor:pointer;font-size:0.95em}
        .nav-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
        .nav-btn-google{background:#4285F4}
        .nav-btn-google:hover{background:#3367d6}
        .nav-btn-apple{background:#000}
        .nav-btn-apple:hover{background:#333}
        .loader{text-align:center;padding:40px;display:none}.loader.active{display:block}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .no-results{text-align:center;padding:40px;color:#7f8c8d;font-size:1.1em}
        .error{background:#e74c3c;color:#fff;padding:15px;border-radius:10px;margin:20px 30px;display:none}
        .error.active{display:block}
        .custom-marker{background:#fff;border-radius:50%;border:2px solid #667eea;display:flex;align-items:center;justify-content:center;font-size:20px;width:40px!important;height:40px!important;line-height:40px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,.3)}
        .depozit-marker{border:3px solid #e74c3c;background:#fff5f5;color:#e74c3c;font-weight:700}
        .center-marker{border:3px solid #2c3e50;background:#34495e;color:#fff;font-weight:700}
        .radius-circle{stroke:#667eea;stroke-width:2;stroke-dasharray:5,5;fill:rgba(102,126,234,.1);fill-opacity:.3}
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>ü•æ Depozite Materiale CizmƒÉrie</h1><p>GƒÉse»ôte furnituri √Æn zona ta</p></div>
        <div class="controls">
            <div class="input-group"><label for="location">Loca»õia de cƒÉutare:</label>
                <input id="location" value="Bucure»ôti, Pia»õa Unirii">
            </div>
            <div class="radius-group">
                <label for="radius">RazƒÉ de cƒÉutare: <span id="radiusValue">10</span> km</label>
                <input type="range" id="radius" min="1" max="50" value="10" class="radius-slider">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="searchBtn">CautƒÉ Depozite</button>
                <button class="btn btn-secondary" id="useLocationBtn">Folose»ôte Loca»õia Mea</button>
            </div>
        </div>
        <div class="error" id="error"></div>
        <div class="loader" id="loader"><div class="spinner"></div><p>Se cautƒÉ depozite de materiale...</p></div>
        <div id="map"></div>
        <div class="results" id="results"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, markersLayer, radiusCircle, centerMarker;

        function initMap(){
            map=L.map('map').setView([45.9432,24.9668],7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
            markersLayer=L.layerGroup().addTo(map);
        }

        async function geocode(address){
            const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=ro&limit=1`);
            const d=await r.json();
            if(d.length===0)throw new Error("Loca»õia nu a fost gƒÉsitƒÉ");
            return {lat:+d[0].lat,lon:+d[0].lon,display_name:d[0].display_name};
        }

        async function findStoresAroundLocation(center,radiusKm){
            const deg=radiusKm/111.32;
            const bbox=[center.lat-deg,center.lon-deg,center.lat+deg,center.lon+deg].join(',');
            // Focused query for shoemaker/cobbler businesses only
            const query=`
                [out:json][timeout:25];
                (
                  node["craft"="shoemaker"](${bbox});
                  node["craft"="cobbler"](${bbox});
                  way["craft"="shoemaker"](${bbox});
                  way["craft"="cobbler"](${bbox});
                  node["shop"="leather"](${bbox});
                  way["shop"="leather"](${bbox});
                );
                out center;`;
            const r=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
            const d=await r.json();
            return processStores(d.elements,center,radiusKm);
        }

        function processStores(els,center,radiusKm){
            const arr=[];
            for(const e of els){
                const lat=e.lat||(e.center&&e.center.lat);
                const lon=e.lon||(e.center&&e.center.lon);
                if(!lat||!lon)continue;
                const dist=distance(center.lat,center.lon,lat,lon);
                if(dist>radiusKm)continue;
                const tags=e.tags||{};
                const storeType=typeFrom(tags);
                
                // Only include stores of type 'Depozit Materiale CizmƒÉrie'
                if(storeType==='Depozit Materiale CizmƒÉrie'){
                    arr.push({
                        name: tags.name||nameFrom(tags),
                        lat,lon,
                        distance:dist,
                        address:addressFrom(tags),
                        phone:tags.phone||"Nu este disponibil",
                        opening_hours:tags.opening_hours||"Nu sunt disponibile",
                        type:storeType,
                        website:tags.website||tags["contact:website"]||null
                    });
                }
            }
            return arr.sort((a,b)=>a.distance-b.distance);
        }

        function nameFrom(t){
            if(t.craft==="shoemaker"||t.craft==="cobbler")return"Atelier CizmƒÉrie";
            if(t.shop==="leather")return"Depozit Materiale Piele pentru CizmƒÉrie";
            return"Furnizor Materiale CizmƒÉrie";
        }

        function typeFrom(t){
            // Only return the specific type we want
            if(t.craft==="shoemaker"||t.craft==="cobbler"||t.shop==="leather"){
                return"Depozit Materiale CizmƒÉrie";
            }
            return""; // Empty string for other types
        }

        function addressFrom(t){
            const p=[];
            if(t["addr:street"])p.push(t["addr:street"]);
            if(t["addr:housenumber"])p.push(t["addr:housenumber"]);
            if(t["addr:city"])p.push(t["addr:city"]);
            return p.length?p.join(", "):"AdresƒÉ nedisponibilƒÉ";
        }

        function distance(a,b,c,d){
            const R=6371, dLat=rad(c-a), dLon=rad(d-b);
            const h=Math.sin(dLat/2)**2+Math.cos(rad(a))*Math.cos(rad(c))*Math.sin(dLon/2)**2;
            return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
        }
        const rad=x=>x*Math.PI/180;

        function displayResults(stores,center,radius){
            const res=document.getElementById("results");
            markersLayer.clearLayers();
            if(radiusCircle)map.removeLayer(radiusCircle);

            radiusCircle=L.circle([center.lat,center.lon],{radius:radius*1000,className:"radius-circle"}).addTo(map);

            centerMarker=L.marker([center.lat,center.lon],{
                icon:L.divIcon({className:"custom-marker center-marker",html:"üìç",iconSize:[40,40]})
            }).addTo(markersLayer);

            if(!stores.length){
                res.innerHTML=`<div class="no-results">Nu s-au gƒÉsit depozite de materiale pentru cizmƒÉrie √Æn raza selectatƒÉ.</div>`;
                return;
            }

            let html=`<h2>Am gƒÉsit ${stores.length} depozite de materiale pentru cizmƒÉrie:</h2>`;
            for(const s of stores){
                html+=`
                <div class="store-card">
                    <div class="store-header">
                        <div class="store-name">${s.name}</div>
                        <div class="distance">${s.distance.toFixed(2)} km</div>
                    </div>
                    <div class="store-info">
                        <div><strong>Tip:</strong> ${s.type}</div>
                        <div><strong>AdresƒÉ:</strong> ${s.address}</div>
                        <div><strong>Telefon:</strong> ${s.phone}</div>
                        <div><strong>Program:</strong> ${s.opening_hours}</div>
                        <div class="coordinates"><strong>Coordonate:</strong> ${s.lat.toFixed(6)}, ${s.lon.toFixed(6)}</div>
                        
                        <div class="navigation-links">
                            <div class="nav-instructions">
                                <strong>Navigare:</strong> ApasƒÉ butonul pentru navigare cu indica»õii vocale.
                            </div>
                            <div class="nav-buttons">
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lon}&travelmode=driving" 
                                   target="_blank"
                                   class="nav-btn nav-btn-google">
                                    üöó Google Maps
                                </a>
                                <a href="http://maps.apple.com/?daddr=${s.lat},${s.lon}&dirflg=d" 
                                   target="_blank"
                                   class="nav-btn nav-btn-apple">
                                    üçè Apple Maps
                                </a>
                            </div>
                        </div>
                        
                        ${s.website?`<div style="margin-top:15px;"><a href="${s.website}" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600;">üåê ViziteazƒÉ Website-ul</a></div>`:""}
                    </div>
                </div>`;
                L.marker([s.lat,s.lon],{
                    icon:L.divIcon({
                        className:"custom-marker depozit-marker",
                        html:"ü•æ",iconSize:[40,40]
                    })
                }).addTo(markersLayer).bindPopup(`
                    <strong>${s.name}</strong><br>
                    ${s.address}<br>
                    <em>${s.distance.toFixed(2)} km distan»õƒÉ</em><br>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lon}&travelmode=driving" target="_blank">üöó NavigheazƒÉ</a>
                `);
            }
            res.innerHTML=html;
        }

        document.getElementById("radius").addEventListener("input",e=>{
            document.getElementById("radiusValue").textContent=e.target.value;
        });

        document.getElementById("searchBtn").onclick=async()=>{
            const loc=document.getElementById("location").value;
            const rad=+document.getElementById("radius").value;
            const loader=document.getElementById("loader");
            const err=document.getElementById("error");
            err.classList.remove("active");loader.classList.add("active");
            try{
                const c=await geocode(loc);
                const stores=await findStoresAroundLocation(c,rad);
                displayResults(stores,c,rad);
                map.setView([c.lat,c.lon],12);
            }catch(e){err.textContent=e.message;err.classList.add("active")}
            loader.classList.remove("active");
        };

        document.getElementById("useLocationBtn").onclick=()=>{
            navigator.geolocation.getCurrentPosition(async pos=>{
                const c={lat:pos.coords.latitude,lon:pos.coords.longitude,display_name:"Loca»õia mea"};
                const rad=+document.getElementById("radius").value;
                const loader=document.getElementById("loader");
                loader.classList.add("active");
                const stores=await findStoresAroundLocation(c,rad);
                displayResults(stores,c,rad);
                map.setView([c.lat,c.lon],12);
                loader.classList.remove("active");
            });
        };

        initMap();
    </script>
</body>
</html>