<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depozite Materiale CizmƒÉrie</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
        .header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:30px;text-align:center}
        .header h1{font-size:2em;margin-bottom:10px}.header p{opacity:.9;font-size:1.1em}
        .controls{padding:30px;background:#f8f9fa;border-bottom:1px solid #e0e0e0}
        .input-group,.radius-group{margin-bottom:20px}
        .input-group label,.radius-group label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50}
        .input-group input{width:100%;padding:12px 15px;border:2px solid #ddd;border-radius:10px;font-size:1em;transition:border-color .3s}
        .input-group input:focus{border-color:#667eea;outline:0}
        .radius-slider{width:100%;margin:10px 0}.radius-value{text-align:center;font-weight:600;color:#667eea;margin-top:5px}
        .btn-group{display:flex;gap:15px;flex-wrap:wrap}
        .btn{flex:1;min-width:150px;padding:15px 30px;border:none;border-radius:10px;font-size:1em;font-weight:600;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:.5px}
        .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.4)}
        .btn-secondary{background:#95a5a6;color:#fff}
        .btn-secondary:hover{background:#7f8c8d}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        #map{height:500px;width:100%}
        .results{padding:30px}.results h2{color:#2c3e50;margin-bottom:20px;font-size:1.5em}
        .store-card{background:#fff;border:2px solid #e0e0e0;border-radius:15px;padding:20px;margin-bottom:20px;transition:.3s}
        .store-card:hover{border-color:#667eea;box-shadow:0 5px 15px rgba(102,126,234,.2);transform:translateY(-2px)}
        .store-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:15px}
        .store-name{font-size:1.3em;font-weight:700;color:#2c3e50}.distance{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:5px 15px;border-radius:20px;font-weight:600;font-size:.9em}
        .store-info{color:#555;line-height:1.8}.store-info strong{color:#2c3e50}
        .coordinates{font-family:monospace;color:#666;font-size:0.9em;margin-top:8px;padding:6px 10px;background:#f8f9fa;border-radius:6px;display:inline-block}
        .plus-code{font-family:monospace;color:#e74c3c;font-size:1em;font-weight:600;letter-spacing:1px;margin-top:8px;padding:6px 10px;background:#fff5f5;border-radius:6px;display:inline-block;border:1px solid #ffcccc}
        .plus-code-info{font-size:0.85em;color:#7f8c8d;margin-top:5px}
        .navigation-links{margin-top:15px;padding-top:15px;border-top:1px dashed #ddd}
        .nav-instructions{color:#666;font-size:0.9em;margin-bottom:10px}
        .nav-buttons{display:flex;gap:10px;flex-wrap:wrap}
        .nav-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;color:white;text-decoration:none;border-radius:8px;font-weight:600;transition:all 0.3s;border:none;cursor:pointer;font-size:0.95em}
        .nav-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
        .nav-btn-google{background:#4285F4}
        .nav-btn-google:hover{background:#3367d6}
        .nav-btn-apple{background:#000}
        .nav-btn-apple:hover{background:#333}
        .nav-btn-waze{background:#33ccff}
        .nav-btn-waze:hover{background:#1ab2ff}
        .plus-code-btn{background:#27ae60}
        .plus-code-btn:hover{background:#219653}
        .copy-btn{background:#9b59b6;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:0.85em;margin-left:8px;transition:background 0.3s}
        .copy-btn:hover{background:#8e44ad}
        .copy-btn:active{transform:scale(0.95)}
        .loader{text-align:center;padding:40px;display:none}.loader.active{display:block}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .no-results{text-align:center;padding:40px;color:#7f8c8d;font-size:1.1em}
        .error{background:#e74c3c;color:#fff;padding:15px;border-radius:10px;margin:20px 30px;display:none}
        .error.active{display:block}
        .custom-marker{background:#fff;border-radius:50%;border:2px solid #667eea;display:flex;align-items:center;justify-content:center;font-size:20px;width:40px!important;height:40px!important;line-height:40px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,.3)}
        .depozit-marker{border:3px solid #e74c3c;background:#fff5f5;color:#e74c3c;font-weight:700}
        .center-marker{border:3px solid #2c3e50;background:#34495e;color:#fff;font-weight:700}
        .radius-circle{stroke:#667eea;stroke-width:2;stroke-dasharray:5,5;fill:rgba(102,126,234,.1);fill-opacity:.3}
        .coordinates-container{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>ü•æ Depozite Materiale CizmƒÉrie</h1><p>GƒÉse»ôte furnituri √Æn zona ta</p></div>
        <div class="controls">
            <div class="input-group"><label for="location">Loca»õia de cƒÉutare:</label>
                <input id="location" value="Bucure»ôti, Pia»õa Unirii">
            </div>
            <div class="radius-group">
                <label for="radius">RazƒÉ de cƒÉutare: <span id="radiusValue">10</span> km</label>
                <input type="range" id="radius" min="1" max="50" value="10" class="radius-slider">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="searchBtn">CautƒÉ Depozite</button>
                <button class="btn btn-secondary" id="useLocationBtn">Folose»ôte Loca»õia Mea</button>
            </div>
        </div>
        <div class="error" id="error"></div>
        <div class="loader" id="loader"><div class="spinner"></div><p>Se cautƒÉ depozite de materiale...</p></div>
        <div id="map"></div>
        <div class="results" id="results"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Simple Plus Code implementation using a proven algorithm
        class PlusCode {
            static CODE_ALPHABET = '23456789CFGHJMPQRVWX';
            static ENCODING_BASE = 20;
            static LATITUDE_MAX = 90;
            static LONGITUDE_MAX = 180;
            static GRID_SIZE_DEGREES = 20;
            static PAIR_CODE_LENGTH = 10;
            static CODE_PRECISION_NORMAL = 10;
            
            static encode(latitude, longitude, codeLength = 10) {
                // Ensure valid latitude and longitude
                latitude = this.clipLatitude(latitude);
                longitude = this.normalizeLongitude(longitude);
                
                // Adjust latitude and longitude
                let lat = latitude + this.LATITUDE_MAX;
                let lng = longitude + this.LONGITUDE_MAX;
                
                // Calculate grid part (first 4 characters)
                let latDigit = Math.floor(lat / this.GRID_SIZE_DEGREES);
                let lngDigit = Math.floor(lng / this.GRID_SIZE_DEGREES);
                
                // Calculate local part
                let localLat = lat - (latDigit * this.GRID_SIZE_DEGREES);
                let localLng = lng - (lngDigit * this.GRID_SIZE_DEGREES);
                
                // Build the code
                let code = '';
                
                // Add grid part (first 2 characters)
                code += this.CODE_ALPHABET.charAt(latDigit);
                code += this.CODE_ALPHABET.charAt(lngDigit);
                
                // Add local part
                let precision = Math.min(codeLength, 15);
                for (let i = 0; i < precision - 2; i += 2) {
                    // For each pair, divide the remaining area by 20
                    localLat /= 20;
                    localLng /= 20;
                    
                    let latVal = Math.floor(localLat);
                    let lngVal = Math.floor(localLng);
                    
                    code += this.CODE_ALPHABET.charAt(latVal);
                    code += this.CODE_ALPHABET.charAt(lngVal);
                    
                    localLat -= latVal;
                    localLng -= lngVal;
                }
                
                // Add separator at position 8
                if (code.length >= 8) {
                    code = code.slice(0, 8) + '+' + code.slice(8);
                }
                
                return code;
            }
            
            static decode(code) {
                // Clean the code
                code = code.toUpperCase().replace('+', '');
                
                if (code.length < 2) {
                    throw new Error('Code too short');
                }
                
                // Get grid part
                const latDigit = this.CODE_ALPHABET.indexOf(code.charAt(0));
                const lngDigit = this.CODE_ALPHABET.indexOf(code.charAt(1));
                
                if (latDigit < 0 || lngDigit < 0) {
                    throw new Error('Invalid characters in code');
                }
                
                let lat = latDigit * this.GRID_SIZE_DEGREES;
                let lng = lngDigit * this.GRID_SIZE_DEGREES;
                
                // Decode local part
                let resolution = this.GRID_SIZE_DEGREES;
                for (let i = 2; i < code.length; i += 2) {
                    resolution /= 20;
                    const latVal = this.CODE_ALPHABET.indexOf(code.charAt(i));
                    const lngVal = this.CODE_ALPHABET.indexOf(code.charAt(i + 1));
                    
                    if (latVal >= 0) lat += latVal * resolution;
                    if (lngVal >= 0) lng += lngVal * resolution;
                }
                
                // Adjust back to actual coordinates
                lat -= this.LATITUDE_MAX;
                lng -= this.LONGITUDE_MAX;
                
                // Add half of the last resolution to get center point
                const lastResolution = resolution;
                
                return {
                    latitude: lat + (lastResolution / 2),
                    longitude: lng + (lastResolution / 2),
                    latitudeCenter: lat + (lastResolution / 2),
                    longitudeCenter: lng + (lastResolution / 2)
                };
            }
            
            static clipLatitude(lat) {
                return Math.max(-90, Math.min(90, lat));
            }
            
            static normalizeLongitude(lng) {
                while (lng < -180) lng += 360;
                while (lng >= 180) lng -= 360;
                return lng;
            }
            
            static getGoogleMapsUrl(plusCode) {
                return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(plusCode)}`;
            }
            
            static getWazeUrl(plusCode) {
                try {
                    const decoded = this.decode(plusCode.replace('+', ''));
                    return `https://www.waze.com/ul?ll=${decoded.latitudeCenter},${decoded.longitudeCenter}&navigate=yes`;
                } catch (e) {
                    return `https://www.waze.com/ul?q=${encodeURIComponent(plusCode)}&navigate=yes`;
                }
            }
            
            static getAppleMapsUrl(plusCode) {
                try {
                    const decoded = this.decode(plusCode.replace('+', ''));
                    return `http://maps.apple.com/?daddr=${decoded.latitudeCenter},${decoded.longitudeCenter}&dirflg=d`;
                } catch (e) {
                    return `http://maps.apple.com/?q=${encodeURIComponent(plusCode)}&dirflg=d`;
                }
            }
            
            static getShortCode(plusCode, referenceLat, referenceLng) {
                try {
                    const fullCode = plusCode.replace('+', '');
                    const refCode = this.encode(referenceLat, referenceLng, 10).replace('+', '');
                    
                    let matchingChars = 0;
                    for (let i = 0; i < Math.min(fullCode.length, refCode.length); i++) {
                        if (fullCode.charAt(i) === refCode.charAt(i)) {
                            matchingChars++;
                        } else {
                            break;
                        }
                    }
                    
                    // Only shorten if we have at least 4 matching characters (grid level)
                    if (matchingChars >= 4) {
                        const shortCode = fullCode.substring(matchingChars);
                        // Add the nearest city or area for context (simplified)
                        return shortCode;
                    }
                    
                    return fullCode;
                } catch (e) {
                    return plusCode.replace('+', '');
                }
            }
        }

        let map, markersLayer, radiusCircle, centerMarker;

        function initMap(){
            map=L.map('map').setView([44.4268,26.1025],12); // Bucharest center
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
            markersLayer=L.layerGroup().addTo(map);
        }

        async function geocode(address){
            const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=ro&limit=1`);
            const d=await r.json();
            if(d.length===0)throw new Error("Loca»õia nu a fost gƒÉsitƒÉ");
            return {
                lat:+d[0].lat,
                lon:+d[0].lon,
                display_name:d[0].display_name,
                plusCode: PlusCode.encode(+d[0].lat, +d[0].lon, 10)
            };
        }

        async function findStoresAroundLocation(center,radiusKm){
            const deg=radiusKm/111.32;
            const bbox=[center.lat-deg,center.lon-deg,center.lat+deg,center.lon+deg].join(',');
            const query=`
                [out:json][timeout:25];
                (
                  node["craft"="shoemaker"](${bbox});
                  node["craft"="cobbler"](${bbox});
                  way["craft"="shoemaker"](${bbox});
                  way["craft"="cobbler"](${bbox});
                  node["shop"="leather"](${bbox});
                  way["shop"="leather"](${bbox});
                );
                out center;`;
            const r=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
            const d=await r.json();
            return processStores(d.elements,center,radiusKm);
        }

        function processStores(els,center,radiusKm){
            const arr=[];
            for(const e of els){
                const lat=e.lat||(e.center&&e.center.lat);
                const lon=e.lon||(e.center&&e.center.lon);
                if(!lat||!lon)continue;
                const dist=distance(center.lat,center.lon,lat,lon);
                if(dist>radiusKm)continue;
                const tags=e.tags||{};
                const storeType=typeFrom(tags);
                
                if(storeType==='Depozit Materiale CizmƒÉrie'){
                    const plusCode = PlusCode.encode(lat, lon, 10);
                    const shortCode = PlusCode.getShortCode(plusCode, center.lat, center.lon);
                    
                    arr.push({
                        name: tags.name||nameFrom(tags),
                        lat,lon,
                        plusCode: plusCode,
                        shortCode: shortCode,
                        distance:dist,
                        address:addressFrom(tags),
                        phone:tags.phone||"Nu este disponibil",
                        opening_hours:tags.opening_hours||"Nu sunt disponibile",
                        type:storeType,
                        website:tags.website||tags["contact:website"]||null
                    });
                }
            }
            return arr.sort((a,b)=>a.distance-b.distance);
        }

        function nameFrom(t){
            if(t.craft==="shoemaker"||t.craft==="cobbler")return"Atelier CizmƒÉrie";
            if(t.shop==="leather")return"Depozit Materiale Piele pentru CizmƒÉrie";
            return"Furnizor Materiale CizmƒÉrie";
        }

        function typeFrom(t){
            if(t.craft==="shoemaker"||t.craft==="cobbler"||t.shop==="leather"){
                return"Depozit Materiale CizmƒÉrie";
            }
            return"";
        }

        function addressFrom(t){
            const p=[];
            if(t["addr:street"])p.push(t["addr:street"]);
            if(t["addr:housenumber"])p.push(t["addr:housenumber"]);
            if(t["addr:city"])p.push(t["addr:city"]);
            return p.length?p.join(", "):"AdresƒÉ nedisponibilƒÉ";
        }

        function distance(a,b,c,d){
            const R=6371, dLat=rad(c-a), dLon=rad(d-b);
            const h=Math.sin(dLat/2)**2+Math.cos(rad(a))*Math.cos(rad(c))*Math.sin(dLon/2)**2;
            return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
        }
        const rad=x=>x*Math.PI/180;

        function displayResults(stores,center,radius){
            const res=document.getElementById("results");
            markersLayer.clearLayers();
            if(radiusCircle)map.removeLayer(radiusCircle);

            radiusCircle=L.circle([center.lat,center.lon],{radius:radius*1000,className:"radius-circle"}).addTo(map);

            centerMarker=L.marker([center.lat,center.lon],{
                icon:L.divIcon({className:"custom-marker center-marker",html:"üìç",iconSize:[40,40]})
            }).addTo(markersLayer).bindPopup(`
                <strong>Loca»õia de cƒÉutare</strong><br>
                ${center.display_name}<br>
                <strong>Plus Code:</strong> ${center.plusCode}
            `);

            if(!stores.length){
                res.innerHTML=`<div class="no-results">Nu s-au gƒÉsit depozite de materiale pentru cizmƒÉrie √Æn raza selectatƒÉ.</div>`;
                return;
            }

            let html=`<h2>Am gƒÉsit ${stores.length} depozite de materiale pentru cizmƒÉrie:</h2>`;
            
            // Also show center location's Plus Code
            html += `
            <div class="store-card" style="background:#f8f9fa;border-color:#667eea;">
                <div class="store-header">
                    <div class="store-name">üìç Loca»õia de cƒÉutare</div>
                </div>
                <div class="store-info">
                    <div><strong>AdresƒÉ:</strong> ${center.display_name}</div>
                    <div class="plus-code">
                        ${center.plusCode}
                        <button class="copy-btn" onclick="copyToClipboard('${center.plusCode}', this)">CopiazƒÉ</button>
                    </div>
                    <div class="plus-code-info">
                        Plus Code pentru loca»õia de cƒÉutare
                    </div>
                </div>
            </div>`;
            
            for(const s of stores){
                const isShortened = s.shortCode.length < s.plusCode.replace('+', '').length;
                
                html+=`
                <div class="store-card">
                    <div class="store-header">
                        <div class="store-name">${s.name}</div>
                        <div class="distance">${s.distance.toFixed(2)} km</div>
                    </div>
                    <div class="store-info">
                        <div><strong>Tip:</strong> ${s.type}</div>
                        <div><strong>AdresƒÉ:</strong> ${s.address}</div>
                        <div><strong>Telefon:</strong> ${s.phone}</div>
                        <div><strong>Program:</strong> ${s.opening_hours}</div>
                        
                        <div class="coordinates-container">
                            <div>
                                <strong>Coordonate tradi»õionale:</strong>
                                <div class="coordinates">${s.lat.toFixed(6)}, ${s.lon.toFixed(6)}</div>
                            </div>
                            <div>
                                <strong>Plus Code:</strong>
                                <div class="plus-code">
                                    ${isShortened ? s.shortCode + ' (scurtat)' : s.plusCode}
                                    <button class="copy-btn" onclick="copyToClipboard('${s.plusCode}', this)">CopiazƒÉ</button>
                                </div>
                                <div class="plus-code-info">
                                    ${isShortened ? `‚úî Cod scurtat relativ la loca»õia de cƒÉutare<br>Cod complet: ${s.plusCode}` : `Cod complet pentru navigare`}
                                </div>
                            </div>
                        </div>
                        
                        <div class="navigation-links">
                            <div class="nav-instructions">
                                <strong>Navigare:</strong> ApasƒÉ butonul pentru navigare cu indica»õii vocale.
                            </div>
                            <div class="nav-buttons">
                                <a href="${PlusCode.getGoogleMapsUrl(s.plusCode)}" 
                                   target="_blank"
                                   class="nav-btn nav-btn-google">
                                    üöó Google Maps
                                </a>
                                <a href="${PlusCode.getAppleMapsUrl(s.plusCode)}" 
                                   target="_blank"
                                   class="nav-btn nav-btn-apple">
                                    üçè Apple Maps
                                </a>
                                <a href="${PlusCode.getWazeUrl(s.plusCode)}" 
                                   target="_blank"
                                   class="nav-btn nav-btn-waze">
                                    üö¶ Waze
                                </a>
                                <a href="https://plus.codes/${s.plusCode.replace('+', '%2B')}" 
                                   target="_blank"
                                   class="nav-btn plus-code-btn">
                                    üîó Plus Code
                                </a>
                            </div>
                        </div>
                        
                        ${s.website?`<div style="margin-top:15px;"><a href="${s.website}" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600;">üåê ViziteazƒÉ Website-ul</a></div>`:""}
                    </div>
                </div>`;
                L.marker([s.lat,s.lon],{
                    icon:L.divIcon({
                        className:"custom-marker depozit-marker",
                        html:"ü•æ",iconSize:[40,40]
                    })
                }).addTo(markersLayer).bindPopup(`
                    <strong>${s.name}</strong><br>
                    ${s.address}<br>
                    <strong>Plus Code:</strong> ${s.plusCode}<br>
                    <em>${s.distance.toFixed(2)} km distan»õƒÉ</em><br>
                    <a href="${PlusCode.getGoogleMapsUrl(s.plusCode)}" target="_blank">üöó NavigheazƒÉ</a>
                `);
            }
            res.innerHTML=html;
        }

        // Clipboard function
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copiat!';
                button.style.background = '#27ae60';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                button.textContent = 'Eroare';
                button.style.background = '#e74c3c';
                setTimeout(() => {
                    button.textContent = 'CopiazƒÉ';
                    button.style.background = '';
                }, 2000);
            });
        }

        // Test Plus Code functionality
        function testPlusCode() {
            // Test coordinates for Bucharest
            const testLat = 44.4268;
            const testLon = 26.1025;
            
            const plusCode = PlusCode.encode(testLat, testLon, 10);
            console.log('Plus Code for Bucharest (44.4268, 26.1025):', plusCode);
            
            const decoded = PlusCode.decode(plusCode.replace('+', ''));
            console.log('Decoded:', decoded);
            
            return plusCode;
        }

        document.getElementById("radius").addEventListener("input",e=>{
            document.getElementById("radiusValue").textContent=e.target.value;
        });

        document.getElementById("searchBtn").onclick=async()=>{
            const loc=document.getElementById("location").value;
            const rad=+document.getElementById("radius").value;
            const loader=document.getElementById("loader");
            const err=document.getElementById("error");
            err.classList.remove("active");loader.classList.add("active");
            try{
                const c=await geocode(loc);
                const stores=await findStoresAroundLocation(c,rad);
                displayResults(stores,c,rad);
                map.setView([c.lat,c.lon],12);
                
                // Test the Plus Code
                console.log('Center Plus Code:', c.plusCode);
                testPlusCode();
            }catch(e){err.textContent=e.message;err.classList.add("active")}
            loader.classList.remove("active");
        };

        document.getElementById("useLocationBtn").onclick=()=>{
            navigator.geolocation.getCurrentPosition(async pos=>{
                const c={
                    lat:pos.coords.latitude,
                    lon:pos.coords.longitude,
                    display_name:"Loca»õia mea",
                    plusCode: PlusCode.encode(pos.coords.latitude, pos.coords.longitude, 10)
                };
                const rad=+document.getElementById("radius").value;
                const loader=document.getElementById("loader");
                loader.classList.add("active");
                const stores=await findStoresAroundLocation(c,rad);
                displayResults(stores,c,rad);
                map.setView([c.lat,c.lon],12);
                loader.classList.remove("active");
            });
        };

        // Initialize and test
        initMap();
        // Run a quick test on load
        setTimeout(testPlusCode, 1000);
    </script>
</body>
</html>